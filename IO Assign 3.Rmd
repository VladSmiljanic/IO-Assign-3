---
title: 'IO Assignment #3'
author: "Vladimir Smiljanic & Juan David Rios"
date: '2017-03-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Question 1

We can define our mean utility for the model to be :

\begin{align*}

\delta_{jt} = x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt}
\end{align*}

Where $u_{ijt} = \delta_{jt}(x_{jt}, p_{jt},m_j, c_t,\xi;\beta,\alpha) + \epsilon_{ijt}$.


(From Berry 1994 paper page 6) Variation in consumer tastes only enters through the error term $\epsilon_{ijt}$ which is assumed to be iid extreme value or logit distribution across all consumers and choices. 

\begin{align*}
F(\delta_{0t}\dots\delta_{Jt}) = \exp(-\exp(-I))\\
\end{align*}

Where $I$ is inclusive value $\ln \sum^J_{k=0}\exp(\delta_k)$. Can interpret $I$ as the expected value of the maximum over all utilities.

As a result, all properties of market demand are determined by $\delta_{jt}$, which includes market shares and elasticities. As a result, cross-price elasticities only depend on $\delta_{jt}$ with no additional effect from product charasteristics and prices. Errors that are iid results in two pairs of goods (ie. cars) with the same market shares will have the same cross-price elasticity with a third good. 

Specification we put to the data by integrating out logit error. 
\begin{align*}
s_{jt} &= \frac{\exp{\delta_{jt}}}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})} \\
\ln{\widehat{s_{jt}}} - \ln{\widehat{s_{0t}}}  &=   x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt} 
\end{align*}

2. *Discuss the endogeneity problem and how you are going to treat it. You can use the observed nonprice attributes as instruments under the assumption that they are exogeneous as in BLP(1995). You can use the sums and the count of characteristics by country and year , and by country year and firm.*

The endogeneity problem in this presentation is obvious. 


3. *Algebraically derive the own price and cross price elasticities in the logit model ( Show all steps)*

For ease of computation define $M_j \equiv \exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})$

Crossprice Elasticity:

\begin{align*}
s_{jt} &= \frac{\exp(\delta_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})} \\
s_{jt} &= \frac{M_j}{1 + \sum^{J}_{k=1} M_k} \\
\frac{\partial M_j}{\partial p_{kt}} &= 0\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \frac{\frac{\partial M_j}{\partial p_{kt}}}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 +\sum^{J}_{k=1} M_k)^2} \times \frac{\partial M_k}{\partial p_{kt}} \\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \frac{0}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 +\sum^{J}_{k=1} M_k)^2} \times (-\alpha M_k)\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \alpha \times \frac{M_j}{1 +\sum^{J}_{k=1} M_k} \times \frac{M_k}{1 + \sum^{J}_{k=1} M_k}\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \alpha s_{jt}s_{kt}\\
\end{align*}

for own price elasticity and k = j : 
\begin{align*}
\frac{\partial s_{jt}}{\partial p_{jt}} &= \frac{\frac{\partial M_j}{\partial p_{jt}}}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 + \sum^{J}_{k=1} M_k)^2} \times \frac{\partial M_j}{\partial p_{jt}} \\
\frac{\partial s_{jt}}{\partial p_{jt}} &= \frac{-\alpha M_j}{1 + \sum^{J}_{k=1} M_j} + \frac{-M_j}{( 1 + \sum^{J}_{k=1} M_k)^2} \times (-\alpha M_j)\\
\frac{\partial s_{jt}}{\partial p_{jt}} &=  - \alpha s_{jt}  + \alpha s^2_{jt}\\
\frac{\partial s_{jt}}{\partial p_{jt}} &=  - \alpha s_{jt}(1 - s_{jt})\\
\end{align*}

NEED TO CLEAN THIS UP , expand price elasticity copied directly out of rasmusen 07'


4. *Estimate the logit using OLS and 2SLS with car model fixed effects, using the instruments discussed above. Report the coefficients and the standard errors for the product characteristics and price. How does the coefficient of price change when you use instruments?*. 

5. *Calculate the elasticities and report summary statistics*.

```{}
clear all
capture log close

cd "/Users/David/GitHub/IO/ps2/IO-Assign-3" //  WD
use "/Users/David/Downloads/HW3/cars1.dta"

summarize year country co segment domestic firm qu price horsepower fuel width height pop ngdp

// Define panel 

egen yearcountry=group(year country), label
xtset co yearcountry

// Defining outside good as MSIZE

gen MSIZE=pop/4

#delimit ;

local characteristics "horsepower fuel width height domestic";

* Sum of the characteristics of all competing products and competing products produced by other firms;


*** 	i_hp= sum(hp)-hp 					sum of the characteristics of all competing products
	if_hp= sum(hp of firm j) - hp  			sum of the characteristics of all other makes of firm j
	CFi_hp= sum(hp)- sum(hp of firm j)		sum of the characteristics of all other non-firm j makes;
	
foreach inst in `characteristics'{;
qui{;
	egen i_`inst'=sum(`inst'), by (year country);
	egen if_`inst'=sum(`inst'), by (year country firm);
	gen CFi_`inst'=i_`inst'-if_`inst';
	replace i_`inst'=i_`inst'-`inst';
	replace if_`inst'=if_`inst'-`inst';
};
};



qui egen tot_sales=sum(qu), by(year country);
qui egen i_num=count(qu), by(year country);

qui egen firm_sales=sum(qu), by(year country firm);
qui egen if_num=count(qu), by(year country firm);


qui gen CFi_num=i_num-if_num;

replace i_num=i_num-1;
gen lni_num=ln(i_num);

replace if_num=if_num-1;
gen lnif_num=ln(if_num);


* PART 2. ONE LEVEL NESTED LOGIT INSTRUMENTS;


* Per year market firm and segment;

*** 	is_hp= sum(hp in segment k)-hp 							sum of the characteristics of all competing products in segment k
	ifs_hp= sum(hp of firm j in segment k) - hp  					sum of the characteristics of all other makes of firm j in segment k
	CFis_hp= sum(hp in segment k)- sum(hp of firm j in segment k)		sum of the characteristics of all other non-firm j makes in segment k;


foreach inst in `characteristics'{;
qui{;
	egen is_`inst'=sum(`inst'),  by (year country segment);
	egen ifs_`inst'=sum(`inst'), by (year country segment firm);
	gen CFis_`inst'=is_`inst'-ifs_`inst';
	replace is_`inst'=is_`inst'-`inst';
	replace ifs_`inst'=ifs_`inst'-`inst';
};
};

egen seg_sales=sum(qu), by(year country segment);
egen is_num=count(qu), by(year country segment);

egen fs_sales=sum(qu), by(year country segment firm);
egen ifs_num=count (qu), by(year country segment firm);

qui gen CFis_num=is_num-ifs_num;

replace is_num=is_num-1;
gen lnis_num=ln(is_num);
replace ifs_num=ifs_num-1;
gen lnifs_num=ln(ifs_num);

mergersim init, nests(segment) price(price) quantity(qu) marketsize(MSIZE) firm(firm);

// THIS DOES the first regression without instruments,
// MERGER SIM creates M_ls which is ln(st) - ln(s0) can gen on my own

xtreg M_ls price horsepower fuel width height domestic year country2-country5, fe;

// USING IV's of sum of characteristic of all competing products group by year and country

xtivreg M_ls (price = i_horsepower i_fuel i_width i_height i_domestic)
				horsepower fuel width height domestic year country2-country5, fe;


```

```{r}
library(foreign)
mydata <- read.dta("/Users/David/Downloads/HW3/cars1.dta")
```
