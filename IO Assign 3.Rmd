---
title: 'IO Assignment #3'
author: "Vladimir Smiljanic & Juan David Rios"
date: '2017-03-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Question 1

We can define the mean utility for product j at time t that all consumers receive:
\begin{align*}
\delta_{jt} = x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt}
\end{align*}
Where $u_{ijt} = \delta_{jt}(x_{jt}, p_{jt},m_j, c_t,\xi;\beta,\alpha) + \epsilon_{ijt}$.

From Berry (1994) we know that the variation in consumer tastes only enters through the error term $\epsilon_{ijt}$ which is assumed to be iid extreme value or logit distribution across all consumers and choices. 
\begin{align*}
F(\delta_{0t}\dots\delta_{Jt}) = \exp(-\exp(-I))\\
\end{align*}
Where $I$ is inclusive value $\ln \sum^J_{k=0}\exp(\delta_k)$. Can interpret $I$ as the expected value of the maximum over all utilities.

As a result, all properties of market demand are determined by $\delta_{jt}$, which includes market shares and elasticities. As a result, cross-price elasticities only depend on $\delta_{jt}$ with no additional effect from product charasteristics and prices. Errors that are iid results in two pairs of goods (ie. cars) with the same market shares will have the same cross-price elasticity with a third good.

Individuals choose the product out of the total products available plus the outside good. The probability that individual i chooses product j takes the following form:
\begin{align*}
s_{jt} &= \frac{\exp(\delta_{j})}{\exp{I}}\\
s_{jt} &= \frac{\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}\\
\end{align*}
We also know the probability that an individual chooses the outside good which is given by. This is due to the fact that we normalize the mean utility that any idividual gets from the outside good to be equal to 0. 
\begin{align*}
s_{0t} &= \frac{\exp(\delta_0)}{\exp(I)}\\ 
s_{0t} &= \frac{1}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}
\end{align*}
After defining $s_{0t}$ and $s_{jt}$ we can now perform a Berry inversion as seen in Berry (1994). 

\begin{align*}
\frac{s_{jt}}{s_{0t}} &=  \frac{\frac{\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}}{\frac{1}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}}  \\
\frac{s_{jt}}{s_{0t}} &= \exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})\\
\ln(\frac{s_{jt}}{s_{0t}}) &= ln(\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt}))\\
\ln(\frac{s_{jt}}{s_{0t}}) &= x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt}
\end{align*}

This is the specification that will be taken to the data using OLS and 2SLS.

2. *Discuss the endogeneity problem and how you are going to treat it. You can use the observed nonprice attributes as instruments under the assumption that they are exogeneous as in BLP(1995). You can use the sums and the count of characteristics by country and year , and by country year and firm.*

The endogeneity problem exists in that there is strong argument to be made that $\xi$ the econometric error term that contains all unobserved characteristics for product j is correlated with price. Thus $E[\xi | X]= 0$. For example one could assume an unobserved characteristic could be the prestige associated with a brand. It would be reasonable to assume that a consumer would get more utility and be willing to pay more for a high prestige brand such as ferrari in comparison to a less prestigious car even holding observed characteristics constant.

The OLS estimation uses observed nonprice attributes of all products in a given year. 
TALK ABOUT HOW THESE ARE UNCORRELATED WITH THE PRICE?..


3. *Algebraically derive the own price and cross price elasticities in the logit model ( Show all steps)*

For ease of computation define $M_j \equiv \exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})$

Crossprice Elasticity:

\begin{align*}
s_{jt} &= \frac{\exp(\delta_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})} \\
s_{jt} &= \frac{M_j}{1 + \sum^{J}_{k=1} M_k} \\
\frac{\partial M_j}{\partial p_{kt}} &= 0\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \frac{\frac{\partial M_j}{\partial p_{kt}}}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 +\sum^{J}_{k=1} M_k)^2} \times \frac{\partial M_k}{\partial p_{kt}} \\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \frac{0}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 +\sum^{J}_{k=1} M_k)^2} \times (-\alpha M_k)\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \alpha \times \frac{M_j}{1 +\sum^{J}_{k=1} M_k} \times \frac{M_k}{1 + \sum^{J}_{k=1} M_k}\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \alpha s_{jt}s_{kt}\\
\end{align*}

for own price elasticity and k = j : 
\begin{align*}
\frac{\partial s_{jt}}{\partial p_{jt}} &= \frac{\frac{\partial M_j}{\partial p_{jt}}}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 + \sum^{J}_{k=1} M_k)^2} \times \frac{\partial M_j}{\partial p_{jt}} \\
\frac{\partial s_{jt}}{\partial p_{jt}} &= \frac{-\alpha M_j}{1 + \sum^{J}_{k=1} M_j} + \frac{-M_j}{( 1 + \sum^{J}_{k=1} M_k)^2} \times (-\alpha M_j)\\
\frac{\partial s_{jt}}{\partial p_{jt}} &=  - \alpha s_{jt}  + \alpha s^2_{jt}\\
\frac{\partial s_{jt}}{\partial p_{jt}} &=  - \alpha s_{jt}(1 - s_{jt})\\
\end{align*}

NEED TO CLEAN THIS UP , expand price elasticity copied directly out of rasmusen 07'


4. *Estimate the logit using OLS and 2SLS with car model fixed effects, using the instruments discussed above. Report the coefficients and the standard errors for the product characteristics and price. How does the coefficient of price change when you use instruments?*. 

Estimating logit using OLS and 2SLS with car model fixed effects as well as instruments. 

```{}
clear all
capture log close

cd "/Users/David/GitHub/IO/ps2/IO-Assign-3" //  WD
use "/Users/David/Downloads/HW3/cars1.dta"

summarize year country co segment domestic firm qu price horsepower fuel width height pop ngdp

// Define panel 

egen yearcountry=group(year country), label
xtset co yearcountry

// Defining outside good as MSIZE

gen MSIZE=pop/4

#delimit ;

local characteristics "horsepower fuel width height domestic";

* Sum of the characteristics of all competing products and competing products produced by other firms;


*** 	i_hp= sum(hp)-hp 					sum of the characteristics of all competing products
	if_hp= sum(hp of firm j) - hp  			sum of the characteristics of all other makes of firm j
	CFi_hp= sum(hp)- sum(hp of firm j)		sum of the characteristics of all other non-firm j makes;
	
foreach inst in `characteristics'{;
qui{;
	egen i_`inst'=sum(`inst'), by (year country);
	egen if_`inst'=sum(`inst'), by (year country firm);
	gen CFi_`inst'=i_`inst'-if_`inst';
	replace i_`inst'=i_`inst'-`inst';
	replace if_`inst'=if_`inst'-`inst';
};
};

qui egen tot_sales=sum(qu), by(year country);
qui egen i_num=count(qu), by(year country);

qui egen firm_sales=sum(qu), by(year country firm);
qui egen if_num=count(qu), by(year country firm);

qui gen CFi_num=i_num-if_num;

replace i_num=i_num-1;
gen lni_num=ln(i_num);

replace if_num=if_num-1;
gen lnif_num=ln(if_num);

mergersim init, nests(segment) price(price) quantity(qu) marketsize(MSIZE) firm(firm);

xtreg M_ls price horsepower fuel width height domestic year country2-country5, fe;
	
xtivreg M_ls (price = i_horsepower i_fuel i_width i_height i_domestic)
	horsepower fuel width height domestic year country2-country5, fe;
```
Coefficients and standard errors for product charactersitics and price. Confirming  

```{}

xtreg M_ls price horsepower fuel width height domestic year country2-country5, fe;

   M_ls |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |   -.050574   .0029855   -16.94   0.000    -.0564261   -.0447218
  horsepower |  -.0105318   .0013525    -7.79   0.000     -.013183   -.0078807
        fuel |  -.0555518   .0104271    -5.33   0.000    -.0759907   -.0351128
       width |   .0618035   .0038153    16.20   0.000     .0543248    .0692822
      height |   .0301939   .0050837     5.94   0.000     .0202289    .0401588
    domestic |   1.852258   .0225663    82.08   0.000     1.808024    1.896492
        year |  -.0448788   .0027147   -16.53   0.000    -.0502001   -.0395575
    country2 |  -.9618966   .0250186   -38.45   0.000    -1.010937   -.9128558
    country3 |  -.8360231   .0250937   -33.32   0.000    -.8852112    -.786835
    country4 |  -.7841082   .0268119   -29.24   0.000    -.8366642   -.7315522
    country5 |  -.5148567   .0337275   -15.27   0.000    -.5809687   -.4487448
       _cons |    69.6166   5.087516    13.68   0.000     59.64416    79.58903


xtivreg M_ls (price = i_horsepower i_fuel i_width i_height i_domestic) horsepower fuel width height domestic year country2-country5, fe

  M_ls |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.1445286   .0197076    -7.33   0.000    -.1831548   -.1059023
  horsepower |   .0045026   .0034189     1.32   0.188    -.0021983    .0112035
        fuel |  -.0631069   .0109934    -5.74   0.000    -.0846535   -.0415602
       width |   .0690599   .0042558    16.23   0.000     .0607187     .077401
      height |   .0332539    .005343     6.22   0.000     .0227819    .0437259
    domestic |   1.818139   .0245872    73.95   0.000     1.769949    1.866329
        year |  -.0636334   .0048078   -13.24   0.000    -.0730566   -.0542103
    country2 |   -.897844    .029286   -30.66   0.000    -.9552436   -.8404444
    country3 |   -.933153   .0330225   -28.26   0.000    -.9978759   -.8684302
    country4 |  -.5688543   .0526361   -10.81   0.000    -.6720192   -.4656895
    country5 |   .2022872   .1526476     1.33   0.185    -.0968965    .5014709
       _cons |   105.9896    9.21641    11.50   0.000     87.92579    124.0535

```

We can see that the coefficient on price decreases as we include instruments. 

5. *Calculate the elasticities and report summary statistics*.

```{r}
library(foreign)
mydata <- read.dta("/Users/David/Downloads/HW3/cars1.dta")
```
# 4.1 Logit Estimation 

Model:

\begin{align*}
u_{ijt} = \beta_0 + \beta^f f_{jt} + \beta^d d_{jt} + \alpha p_{jt} + \xi_{jt} + \epsilon_{ijt}
\end{align*}

constant: vector of ones,
f: amount of caffeine 
d: degrees of roasting
Zopt : Instrument Matrix 
shares: Market Share 

Estimating model using ols in MATLAB, must have data.mat in memory. I don't include constant in 1 since Lfit already includes constant.  

```{}
lnshares = log(shares)
X = [constant,p,f,d]
mdl = fitlm(X,lnshares)
mdl.Coefficients

ans = 
                   Estimate       SE        tStat       pValue   
                   ________    ________    _______    ___________

    (Intercept)          0            0        NaN            NaN
    x1             0.39685      0.50184    0.79079        0.42983
    x2             -1.7528     0.032324    -54.225    1.8198e-138
    x3              2.9999       0.2169     13.831     1.5287e-32
    x4             0.82219      0.22297     3.6875     0.00027893
```
Using Matrix notation found in Cameron Trivendi because I couldn't find 2SLS function. 

```{}
X = [constant,p,f,d]
Z = instrument

B2SLS = inv(X.'*Z*inv(Z.'*Z)*Z.'*X)*X.'*Z*inv(Z.'*Z)*Z.'*lnshares

ans = 

B2SLS =

    1.7079
   -1.9519
    3.1361
    0.9306

 u = minus(lnshares,X*B2SLS)
 s2 = ((250-4)^-1)*u.'*u
 VB2ls = s2*inv(X.'*Z*inv(Z.'*Z)*Z.'*X)

VB2ls =

    0.3126   -0.0114   -0.0682   -0.0736
   -0.0114    0.0017   -0.0012   -0.0009
   -0.0682   -0.0012    0.0543   -0.0024
   -0.0736   -0.0009   -0.0024    0.0573

SE = diag(sqrt(VB2ls))

SE =

    0.5591
    0.0416
    0.2331
    0.2394
```

There must be a better way to do Varinace. Here i get the projection matrix , generate residuals, calculate variance under homoskedasticity 

Compare standard errors and coefficients. This model is correct cause of part 2. 

# 4.2 Random Coefficients Logit (BLP)

1. 

2. 

Results with 10 draws 

```{}
Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6810]    [  0.6540]    [  4.0992]
    'price'         [-1.9808]    [  0.0466]    [-42.5372]
    'char1'         [ 1.9077]    [  0.4342]    [  4.3936]
    'char2'         [ 0.9549]    [  0.2648]    [  3.6067]
    'sigmachar1'    [ 1.3902]    [  0.2849]    [  4.8790]
```

Results with 50 draws 

```{}
Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6029]    [  0.5835]    [  4.4607]
    'price'         [-1.9815]    [  0.0408]    [-48.5259]
    'char1'         [ 2.3482]    [  0.3197]    [  7.3458]
    'char2'         [ 0.8895]    [  0.2338]    [  3.8048]
    'sigmachar1'    [ 0.9038]    [  0.1400]    [  6.4537]
```

Results with 100 draws

```{}

Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6263]    [  0.5650]    [  4.6486]
    'price'         [-1.9774]    [  0.0401]    [-49.3514]
    'char1'         [ 2.2058]    [  0.3225]    [  6.8401]
    'char2'         [ 0.9889]    [  0.2285]    [  4.3273]
    'sigmachar1'    [-0.9160]    [  0.1311]    [ -6.9849]
```
```{}
gen outsidegood2 = MSIZE - tot_sales
gen M = ln(qu) - ln(outsidegood2)
// this term is the same as M_ls
```
