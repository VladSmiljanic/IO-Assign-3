---
title: 'IO Assignment #3'
author: "Vladimir Smiljanic & Juan David Rios"
date: '2017-03-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Question 1

We can define the mean utility for product j at time t that all consumers receive:
\begin{align*}
\delta_{jt} = x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt}
\end{align*}
Where $u_{ijt} = \delta_{jt}(x_{jt}, p_{jt},m_j, c_t,\xi;\beta,\alpha) + \epsilon_{ijt}$.

From Berry (1994) we know that the variation in consumer tastes only enters through the error term $\epsilon_{ijt}$ which is assumed to be iid extreme value or logit distribution across all consumers and choices. 
\begin{align*}
F(\delta_{0t}\dots\delta_{Jt}) = \exp(-\exp(-I))\\
\end{align*}
Where $I$ is inclusive value $\ln \sum^J_{k=0}\exp(\delta_k)$. Can interpret $I$ as the expected value of the maximum over all utilities.

As a result, all properties of market demand are determined by $\delta_{jt}$, which includes market shares and elasticities. As a result, cross-price elasticities only depend on $\delta_{jt}$ with no additional effect from product charasteristics and prices. Errors that are iid results in two pairs of goods (ie. cars) with the same market shares will have the same cross-price elasticity with a third good.

Individuals choose the product out of the total products available plus the outside good. The probability that individual i chooses product j takes the following form:
\begin{align*}
s_{jt} &= \frac{\exp(\delta_{j})}{\exp{I}}\\
s_{jt} &= \frac{\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}\\
\end{align*}
We also know the probability that an individual chooses the outside good which is given by. This is due to the fact that we normalize the mean utility that any idividual gets from the outside good to be equal to 0. 
\begin{align*}
s_{0t} &= \frac{\exp(\delta_0)}{\exp(I)}\\ 
s_{0t} &= \frac{1}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}
\end{align*}
After defining $s_{0t}$ and $s_{jt}$ we can now perform a Berry inversion as seen in Berry (1994). 

\begin{align*}
\frac{s_{jt}}{s_{0t}} &=  \frac{\frac{\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}}{\frac{1}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}}  \\
\frac{s_{jt}}{s_{0t}} &= \exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})\\
\ln(\frac{s_{jt}}{s_{0t}}) &= ln(\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt}))\\
\ln(\frac{s_{jt}}{s_{0t}}) &= x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt}
\end{align*}

This is the specification that will be taken to the data using OLS and 2SLS.

2. *Discuss the endogeneity problem and how you are going to treat it. You can use the observed nonprice attributes as instruments under the assumption that they are exogeneous as in BLP(1995). You can use the sums and the count of characteristics by country and year , and by country year and firm.*

The endogeneity problem exists in that there is strong argument to be made that $\xi$ the econometric error term that contains all unobserved characteristics for product j is correlated with price. Thus $E[\xi | X]= 0$. For example one could assume an unobserved characteristic could be the prestige associated with a brand. It would be reasonable to assume that a consumer would get more utility and be willing to pay more for a high prestige brand such as ferrari in comparison to a less prestigious car even holding observed characteristics constant.

The OLS estimation uses observed nonprice attributes of all products in a given year. 
TALK ABOUT HOW THESE ARE UNCORRELATED WITH THE PRICE?..


3. *Algebraically derive the own price and cross price elasticities in the logit model ( Show all steps)*

For ease of computation define $M_j \equiv \exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \lambda c_t + \xi_{jt})$

Crossprice Elasticity:

\begin{align*}
s_{jt} &= \frac{\exp(\delta_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})} \\
s_{jt} &= \frac{M_j}{1 + \sum^{J}_{k=1} M_k} \\
\frac{\partial M_j}{\partial p_{kt}} &= 0\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \frac{\frac{\partial M_j}{\partial p_{kt}}}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 +\sum^{J}_{k=1} M_k)^2} \times \frac{\partial M_k}{\partial p_{kt}} \\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \frac{0}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 +\sum^{J}_{k=1} M_k)^2} \times (-\alpha M_k)\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \alpha \times \frac{M_j}{1 +\sum^{J}_{k=1} M_k} \times \frac{M_k}{1 + \sum^{J}_{k=1} M_k}\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \alpha s_{jt}s_{kt}\\
\end{align*}

for own price elasticity and k = j : 
\begin{align*}
\frac{\partial s_{jt}}{\partial p_{jt}} &= \frac{\frac{\partial M_j}{\partial p_{jt}}}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 + \sum^{J}_{k=1} M_k)^2} \times \frac{\partial M_j}{\partial p_{jt}} \\
\frac{\partial s_{jt}}{\partial p_{jt}} &= \frac{-\alpha M_j}{1 + \sum^{J}_{k=1} M_j} + \frac{-M_j}{( 1 + \sum^{J}_{k=1} M_k)^2} \times (-\alpha M_j)\\
\frac{\partial s_{jt}}{\partial p_{jt}} &=  - \alpha s_{jt}  + \alpha s^2_{jt}\\
\frac{\partial s_{jt}}{\partial p_{jt}} &=  - \alpha s_{jt}(1 - s_{jt})\\
\end{align*}

NEED TO CLEAN THIS UP , expand price elasticity copied directly out of rasmusen 07'


4. *Estimate the logit using OLS and 2SLS with car model fixed effects, using the instruments discussed above. Report the coefficients and the standard errors for the product characteristics and price. How does the coefficient of price change when you use instruments?*. 

5. *Calculate the elasticities and report summary statistics*.

```{}
clear all
capture log close

cd "/Users/David/GitHub/IO/ps2/IO-Assign-3" //  WD
use "/Users/David/Downloads/HW3/cars1.dta"

summarize year country co segment domestic firm qu price horsepower fuel width height pop ngdp

// Define panel 

egen yearcountry=group(year country), label
xtset co yearcountry

// Defining outside good as MSIZE

gen MSIZE=pop/4

#delimit ;

local characteristics "horsepower fuel width height domestic";

* Sum of the characteristics of all competing products and competing products produced by other firms;


*** 	i_hp= sum(hp)-hp 					sum of the characteristics of all competing products
	if_hp= sum(hp of firm j) - hp  			sum of the characteristics of all other makes of firm j
	CFi_hp= sum(hp)- sum(hp of firm j)		sum of the characteristics of all other non-firm j makes;
	
foreach inst in `characteristics'{;
qui{;
	egen i_`inst'=sum(`inst'), by (year country);
	egen if_`inst'=sum(`inst'), by (year country firm);
	gen CFi_`inst'=i_`inst'-if_`inst';
	replace i_`inst'=i_`inst'-`inst';
	replace if_`inst'=if_`inst'-`inst';
};
};



qui egen tot_sales=sum(qu), by(year country);
qui egen i_num=count(qu), by(year country);

qui egen firm_sales=sum(qu), by(year country firm);
qui egen if_num=count(qu), by(year country firm);


qui gen CFi_num=i_num-if_num;

replace i_num=i_num-1;
gen lni_num=ln(i_num);

replace if_num=if_num-1;
gen lnif_num=ln(if_num);


* PART 2. ONE LEVEL NESTED LOGIT INSTRUMENTS;


* Per year market firm and segment;

*** 	is_hp= sum(hp in segment k)-hp 							sum of the characteristics of all competing products in segment k
	ifs_hp= sum(hp of firm j in segment k) - hp  					sum of the characteristics of all other makes of firm j in segment k
	CFis_hp= sum(hp in segment k)- sum(hp of firm j in segment k)		sum of the characteristics of all other non-firm j makes in segment k;


foreach inst in `characteristics'{;
qui{;
	egen is_`inst'=sum(`inst'),  by (year country segment);
	egen ifs_`inst'=sum(`inst'), by (year country segment firm);
	gen CFis_`inst'=is_`inst'-ifs_`inst';
	replace is_`inst'=is_`inst'-`inst';
	replace ifs_`inst'=ifs_`inst'-`inst';
};
};

egen seg_sales=sum(qu), by(year country segment);
egen is_num=count(qu), by(year country segment);

egen fs_sales=sum(qu), by(year country segment firm);
egen ifs_num=count (qu), by(year country segment firm);

qui gen CFis_num=is_num-ifs_num;

replace is_num=is_num-1;
gen lnis_num=ln(is_num);
replace ifs_num=ifs_num-1;
gen lnifs_num=ln(ifs_num);

mergersim init, nests(segment) price(price) quantity(qu) marketsize(MSIZE) firm(firm);

xtreg M_ls price horsepower fuel width height domestic year country2-country5, fe;

xtivreg M_ls (price = i_horsepower i_fuel i_width i_height i_domestic 
		if_horsepower if_fuel if_width if_height if_domestic)
	horsepower fuel width height domestic year country2-country5, fe;
gen outsidegood2 = MSIZE - tot_sales
gen M = ln(qu) - ln(outsidegood2)
// this term is the same as M_ls
```

```{r}
library(foreign)
mydata <- read.dta("/Users/David/Downloads/HW3/cars1.dta")
```
# 4.1 Logit Estimation 

Model:

\begin{align*}
u_{ijt} = \beta_0 + \beta^f f_{jt} + \beta^d d_{jt} + \alpha p_{jt} + \xi_{jt} + \epsilon_{ijt}
\end{align*}

constant: vector of ones,
f: amount of caffeine 
d: degrees of roasting
Zopt : Instrument Matrix 
shares: Market Share 

Estimating model using ols in MATLAB, must have data.mat in memory. I don't include constant in 1 since Lfit already includes constant.  

```{}
lnshares = log(shares)
X = [constant,p,f,d]
mdl = fitlm(X,lnshares)
mdl.Coefficients

ans = 
                   Estimate       SE        tStat       pValue   
                   ________    ________    _______    ___________

    (Intercept)          0            0        NaN            NaN
    x1             0.39685      0.50184    0.79079        0.42983
    x2             -1.7528     0.032324    -54.225    1.8198e-138
    x3              2.9999       0.2169     13.831     1.5287e-32
    x4             0.82219      0.22297     3.6875     0.00027893
```
Using Matrix notation found in Cameron Trivendi because I couldn't find 2SLS function. 

```{}
X = [constant,p,f,d]
Z = instrument

B2SLS = inv(X.'*Z*inv(Z.'*Z)*Z.'*X)*X.'*Z*inv(Z.'*Z)*Z.'*lnshares

ans = 

B2SLS =

    1.7079
   -1.9519
    3.1361
    0.9306

 u = minus(lnshares,X*B2SLS)
 s2 = ((250-4)^-1)*u.'*u
 VB2ls = s2*inv(X.'*Z*inv(Z.'*Z)*Z.'*X)

VB2ls =

    0.3126   -0.0114   -0.0682   -0.0736
   -0.0114    0.0017   -0.0012   -0.0009
   -0.0682   -0.0012    0.0543   -0.0024
   -0.0736   -0.0009   -0.0024    0.0573

SE = diag(sqrt(VB2ls))

SE =

    0.5591
    0.0416
    0.2331
    0.2394
```

There must be a better way to do Varinace. Here i get the projection matrix , generate residuals, calculate variance under homoskedasticity 

Compare standard errors and coefficients. This model is correct cause of part 2. 

# 4.2 Random Coefficients Logit (BLP)

1. 

2. 

Results with 10 draws 

```{}
Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6810]    [  0.6540]    [  4.0992]
    'price'         [-1.9808]    [  0.0466]    [-42.5372]
    'char1'         [ 1.9077]    [  0.4342]    [  4.3936]
    'char2'         [ 0.9549]    [  0.2648]    [  3.6067]
    'sigmachar1'    [ 1.3902]    [  0.2849]    [  4.8790]
```

Results with 50 draws 

```{}
Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6029]    [  0.5835]    [  4.4607]
    'price'         [-1.9815]    [  0.0408]    [-48.5259]
    'char1'         [ 2.3482]    [  0.3197]    [  7.3458]
    'char2'         [ 0.8895]    [  0.2338]    [  3.8048]
    'sigmachar1'    [ 0.9038]    [  0.1400]    [  6.4537]
```

Results with 100 draws

```{}

Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6263]    [  0.5650]    [  4.6486]
    'price'         [-1.9774]    [  0.0401]    [-49.3514]
    'char1'         [ 2.2058]    [  0.3225]    [  6.8401]
    'char2'         [ 0.9889]    [  0.2285]    [  4.3273]
    'sigmachar1'    [-0.9160]    [  0.1311]    [ -6.9849]
```
