---
title: 'IO Assignment #3'
author: "Vladimir Smiljanic & Juan David Rios"
date: '2017-03-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Question 1

We can define the mean utility for product j at time t that all consumers receive:
\begin{align*}
\delta_{jt} = x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \xi_{jt}
\end{align*}
Where $u_{ijt} = \delta_{jt}(x_{jt}, p_{jt},m_j,\xi;\beta,\alpha) + \lambda c_t + \epsilon_{ijt}$.

From Berry (1994) we know that the variation in consumer tastes only enters through the error term $\epsilon_{ijt}$ which is assumed to be iid extreme value or logit distribution across all consumers and choices. 
\begin{align*}
F(\delta_{0t}\dots\delta_{Jt}) = \exp(-\exp(-I))\\
\end{align*}
Where $I$ is inclusive value $\ln \sum^J_{k=0}\exp(\delta_k)$. Can interpret $I$ as the expected value of the maximum over all utilities.

As a result, all properties of market demand are determined by $\delta_{jt}$, which includes market shares and elasticities. As a result, cross-price elasticities only depend on $\delta_{jt}$ with no additional effect from product charasteristics and prices. Errors that are iid results in two pairs of goods (ie. cars) with the same market shares will have the same cross-price elasticity with a third good.

Individuals choose the product out of the total products available plus the outside good. The probability that individual i chooses product j takes the following form:
\begin{align*}
s_{jt} &= \frac{\exp(\delta_{j})}{\exp{I}}\\
s_{jt} &= \frac{\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \xi_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}\\
\end{align*}
We also know the probability that an individual chooses the outside good which is given by. This is due to the fact that we normalize the mean utility that any idividual gets from the outside good to be equal to 0. 
\begin{align*}
s_{0t} &= \frac{\exp(\delta_0)}{\exp(I)}\\ 
s_{0t} &= \frac{1}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}
\end{align*}
After defining $s_{0t}$ and $s_{jt}$ we can now perform a Berry inversion as seen in Berry (1994). 

\begin{align*}
\frac{s_{jt}}{s_{0t}} &=  \frac{\frac{\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \xi_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}}{\frac{1}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})}}  \\
\frac{s_{jt}}{s_{0t}} &= \exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \xi_{jt})\\
\ln(\frac{s_{jt}}{s_{0t}}) &= ln(\exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \xi_{jt}))\\
\ln(\frac{s_{jt}}{s_{0t}}) &= x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \xi_{jt}
\end{align*}

This is the specification that will be taken to the data using OLS and 2SLS.

2. *Discuss the endogeneity problem and how you are going to treat it. You can use the observed nonprice attributes as instruments under the assumption that they are exogeneous as in BLP(1995). You can use the sums and the count of characteristics by country and year , and by country year and firm.*

The endogeneity problem exists in that there is strong argument to be made that $\xi$ the econometric error term that contains all unobserved characteristics for product j is correlated with price. Thus $E[\xi | X]= 0$. For example one could assume an unobserved characteristic could be the prestige associated with a brand. It would be reasonable to assume that a consumer would get more utility and be willing to pay more for a high prestige brand such as ferrari in comparison to a less prestigious car even holding observed characteristics constant.

The OLS estimation uses observed nonprice attributes of all products in a given year. 
TALK ABOUT HOW THESE ARE UNCORRELATED WITH THE PRICE?..


3. *Algebraically derive the own price and cross price elasticities in the logit model ( Show all steps)*

For ease of computation define $M_j \equiv \exp(x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \xi_{jt})$

Crossprice Elasticity:

\begin{align*}
s_{jt} &= \frac{\exp(\delta_{jt})}{1 + \sum^{J}_{k=1} \exp(\delta_{kt})} \\
s_{jt} &= \frac{M_j}{1 + \sum^{J}_{k=1} M_k} \\
\frac{\partial M_j}{\partial p_{kt}} &= 0\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \frac{\frac{\partial M_j}{\partial p_{kt}}}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 +\sum^{J}_{k=1} M_k)^2} \times \frac{\partial M_k}{\partial p_{kt}} \\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \frac{0}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 +\sum^{J}_{k=1} M_k)^2} \times (-\alpha M_k)\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \alpha \times \frac{M_j}{1 +\sum^{J}_{k=1} M_k} \times \frac{M_k}{1 + \sum^{J}_{k=1} M_k}\\
\frac{\partial s_{jt}}{\partial p_{kt}} &= \alpha s_{jt}s_{kt}\\
\end{align*}

We can now use this to find our crossprice elasticity:
\begin{align*}
\frac{\partial q_k}{\partial p_j}\frac{p_j}{q_k} &= \frac{L\partial s_k}{\partial p_j}\frac{p_j}{q_k}\\
&= L (\alpha s_{j}s_{k})\frac{p_j}{q_k}\\
&= L (\alpha s_{j}\frac{q_k}{L})\frac{p_j}{q_k}\\
&= \alpha s_j p_j\\
\end{align*}


for own price elasticity and k = j : 
\begin{align*}
\frac{\partial s_{jt}}{\partial p_{jt}} &= \frac{\frac{\partial M_j}{\partial p_{jt}}}{1 + \sum^{J}_{k=1} M_k} + \frac{-M_j}{(1 + \sum^{J}_{k=1} M_k)^2} \times \frac{\partial M_j}{\partial p_{jt}} \\
\frac{\partial s_{jt}}{\partial p_{jt}} &= \frac{-\alpha M_j}{1 + \sum^{J}_{k=1} M_j} + \frac{-M_j}{( 1 + \sum^{J}_{k=1} M_k)^2} \times (-\alpha M_j)\\
\frac{\partial s_{jt}}{\partial p_{jt}} &=  - \alpha s_{jt}  + \alpha s^2_{jt}\\
\frac{\partial s_{jt}}{\partial p_{jt}} &=  - \alpha s_{jt}(1 - s_{jt})\\
\end{align*}

We can use similar procedure to solve for own price elasticity:

\begin{align*}
\frac{\partial q_j}{\partial p_j}\frac{p_j}{q_k} &= \frac{L\partial s_j}{\partial p_j}\frac{p_j}{q_j}\\
&= L (- \alpha s_{j}(1 - s_{j})\frac{p_j}{q_j}\\
&= L (-\alpha s_{j}\frac{q_j}{L})(1 - s_{j})\frac{p_j}{q_j}\\
&= -\alpha p_j(1-s_j)\\
\end{align*}
NEED TO CLEAN THIS UP , expand price elasticity copied directly out of rasmusen 07'


4. *Estimate the logit using OLS and 2SLS with car model fixed effects, using the instruments discussed above. Report the coefficients and the standard errors for the product characteristics and price. How does the coefficient of price change when you use instruments?*. 

Estimating logit using OLS and 2SLS with car model fixed effects as well as instruments. 

```{}
clear all
capture log close

cd "/Users/David/GitHub/IO/ps2/IO-Assign-3" //  WD
use "/Users/David/Downloads/HW3/cars1.dta"

summarize year country co segment domestic firm qu price horsepower fuel width height pop ngdp

// Define panel 

egen yearcountry=group(year country), label
xtset co yearcountry

// Defining outside good as MSIZE

gen MSIZE=pop/4

#delimit ;

local characteristics "horsepower fuel width height domestic";

* Sum of the characteristics of all competing products and competing products produced by other firms;


*** 	i_hp= sum(hp)-hp 					sum of the characteristics of all competing products
	if_hp= sum(hp of firm j) - hp  			sum of the characteristics of all other makes of firm j
	CFi_hp= sum(hp)- sum(hp of firm j)		sum of the characteristics of all other non-firm j makes;
	
foreach inst in `characteristics'{;
qui{;
	egen i_`inst'=sum(`inst'), by (year country);
	egen if_`inst'=sum(`inst'), by (year country firm);
	gen CFi_`inst'=i_`inst'-if_`inst';
	replace i_`inst'=i_`inst'-`inst';
	replace if_`inst'=if_`inst'-`inst';
};
};

qui egen tot_sales=sum(qu), by(year country);
qui egen i_num=count(qu), by(year country);

qui egen firm_sales=sum(qu), by(year country firm);
qui egen if_num=count(qu), by(year country firm);

qui gen CFi_num=i_num-if_num;

replace i_num=i_num-1;
gen lni_num=ln(i_num);

replace if_num=if_num-1;
gen lnif_num=ln(if_num);

*Code from page 55 of her session 3 notes. We solve for the dependent variables values using this method. This one is using characertistics by country and year. The ivreg uses characteristics for country, year and country, year and firm.

gen rewr=ln(qu/(MSIZE-tot_sales));

xtreg rewr price horsepower fuel width height domestic year country2-country5, fe;

xtivreg rewr (price = 	i_horsepower i_fuel i_width i_height i_domestic i_num
							if_horsepower if_fuel if_width if_height if_domestic i_num)
							horsepower fuel width height domestic year country2-country5, fe;


	
```

*Coefficients and standard errors for product charactersitics and price*

```{}

xtreg rewr price horsepower fuel width height domestic year country2-country5, fe;

Fixed-effects (within) regression               Number of obs      =     11483
Group variable: co                              Number of groups   =       351

R-sq:  within  = 0.4439                         Obs per group: min =         1
       between = 0.1552                                        avg =      32.7
       overall = 0.3471                                        max =       146

                                                F(11,11121)        =    807.15
corr(u_i, Xb)  = -0.0355                        Prob > F           =    0.0000

------------------------------------------------------------------------------
        rewr |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |   -.050574   .0029855   -16.94   0.000    -.0564261   -.0447218
  horsepower |  -.0105318   .0013525    -7.79   0.000     -.013183   -.0078807
        fuel |  -.0555518   .0104271    -5.33   0.000    -.0759907   -.0351128
       width |   .0618035   .0038153    16.20   0.000     .0543248    .0692822
      height |   .0301939   .0050837     5.94   0.000     .0202289    .0401588
    domestic |   1.852258   .0225663    82.08   0.000     1.808024    1.896492
        year |  -.0448788   .0027147   -16.53   0.000    -.0502001   -.0395575
    country2 |  -.9618966   .0250186   -38.45   0.000    -1.010937   -.9128558
    country3 |  -.8360231   .0250937   -33.32   0.000    -.8852112    -.786835
    country4 |  -.7841082   .0268119   -29.24   0.000    -.8366642   -.7315522
    country5 |  -.5148567   .0337275   -15.27   0.000    -.5809687   -.4487448
       _cons |    69.6166   5.087516    13.68   0.000     59.64416    79.58903
-------------+----------------------------------------------------------------
     sigma_u |  1.0115597
     sigma_e |  .83600972
         rho |  .59416655   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F test that all u_i=0:     F(350, 11121) =    28.23          Prob > F = 0.0000

. xtivreg rewr (price =   i_horsepower i_fuel i_width i_height i_domestic i_num
>                                                         if_horsepower if_fuel if_width if_height if_domesti
> c i_num)
>                                                         horsepower fuel width height domestic year country2
> -country5, fe;
note: i_num omitted because of collinearity

Fixed-effects (within) IV regression         Number of obs      =        11483
Group variable: co                           Number of groups   =          351

R-sq:  within  = 0.4299                      Obs per group: min =            1
       between = 0.1897                                     avg =         32.7
       overall = 0.3501                                     max =          146

                                             Wald chi2(11)      =    848625.94
corr(u_i, Xb)  = -0.0999                     Prob > chi2        =       0.0000

------------------------------------------------------------------------------
        rewr |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.1005664   .0177525    -5.66   0.000    -.1353608   -.0657721
  horsepower |  -.0025321   .0031163    -0.81   0.416    -.0086399    .0035757
        fuel |  -.0595718    .010651    -5.59   0.000    -.0804474   -.0386962
       width |   .0656646   .0040925    16.04   0.000     .0576433    .0736858
      height |   .0318221   .0051788     6.14   0.000     .0216718    .0419724
    domestic |   1.834104   .0237157    77.34   0.000     1.787622    1.880586
        year |   -.054858    .004444   -12.34   0.000     -.063568    -.046148
    country2 |  -.9278147   .0279989   -33.14   0.000    -.9826915   -.8729379
    country3 |  -.8877051   .0311868   -28.46   0.000    -.9488302     -.82658
    country4 |  -.6695734   .0484069   -13.83   0.000    -.7644492   -.5746975
    country5 |  -.1332703   .1378219    -0.97   0.334    -.4033964    .1368557
       _cons |   88.97039   8.508741    10.46   0.000     72.29356    105.6472
-------------+----------------------------------------------------------------
     sigma_u |  1.0364758
     sigma_e |  .84648344
         rho |  .59988403   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F  test that all u_i=0:     F(350,11121) =    26.70       Prob > F    = 0.0000
------------------------------------------------------------------------------
Instrumented:   price
Instruments:    horsepower fuel width height domestic year country2 country3
                country4 country5 i_horsepower i_fuel i_width i_height
                i_domestic i_num if_horsepower if_fuel if_width if_height
                if_domestic
------------------------------------------------------------------------------

```


We can see that the coefficient on price decreases as we include instruments. 

5. *Calculate the elasticities and report summary statistics*.

From our summary table for coefficients and standards errors, we seee that our coefficient on prices for logit model with instrumental variables is -0.1005664. We can input that value into our price elasticity equation and summarize the results.

*Own price elasticities*
```{}

. gen alp = -.1005664;

.  gen sj = qu/MSIZE;

. gen oel=(alp)*price*(1-sj);

. sum oel;

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
         oel |     11483   -1.857588    .8975175  -15.11824  -.5274911

```

*Cross-price elasticities*
```{}
. gen cel = -(alp)*price*(sj);

. sum cel;

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
         cel |     11483    .0025719    .0038055   .0000141    .035288


```

#Question 2

1. Deriving Berry-one-level nested logit begining from the utility following utility specification. 
\begin{align*}
u_{ijt} = \delta_{jt}(x_{jt}, p_{jt},m_j,\xi;\beta,\alpha) + \lambda c_t + \epsilon_{ijt}
\end{align*}

We than divide the products into mutually exclusive nests which we note by $g = 0 \dots G$ where $g=0$ is the nest that only contains the outside good. 

In the nested logiot the individual error term $\epsilon_{ijt}$ is composed of two parts
\begin{align*}
\epsilon_{ijt} = (1-\sigma_g)\epsilon{igt} + \epsilon_{ijt}^1
\end{align*}

The first term $\epsilon{igt}$ is an error shared by all products in nest g. The second term $\epsilon_{ijt}^1$ is an i.i.d extreme value shock similar to the one seen in the logit in question 1. The term $(1-\sigma_g)$ denotes how important the within nest shock in comparison to the extreme value shock.  $\epsilon{igt}$ has the property that it is distributed in such a manner that it makes the whole term $(1-\sigma_g)\epsilon{igt} + \epsilon_{ijt}^1$ also type one extreme value distributed. Since we assume that heterogeneity across clusters we can assume that $\sigma_g = \sigma \textrm{ for all } g$. 

Since \epsilon_{ijt} is extreme value distributed $F(\delta_{0t}\dots\delta_{Jt}) = \exp(-\exp(-I))$. 

Following the same notation as Berry 1994: 
\begin{align*}
D_g &= \sum^{J_g}_{j=1}\exp(\delta_j/(1-\sigma_g)))\\
I_g&=(1-\sigma_g)\ln(D_g)\\
I&=\ln(\sum^G_{g=0}D^{(1-\sigma_g)}_g)\\  
\end{align*}

Our market share equations become
\begin{align*}
s_{j} &= \frac{\exp(\delta_{j}/(1-\sigma_g))\exp((1-\sigma_g)\ln(D_g))}{(D_g)(\sum^G_{g=0}D^{(1-\sigma_g)}_g)} \\
s_{j} &= \frac{\exp(\delta_{j}/(1-\sigma_g))}{D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g}\\
s_{0} &= \frac{1}{\sum^G_{g=0}D^{(1-\sigma_g)}_g}
\end{align*}

\begin{align*}
\ln(s_{j}) &= \frac{\exp(\delta_{j}/(1-\sigma_g))}{D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g}) \\
\ln(s_{j}) &= \frac{\delta_{j}}{(1-\sigma_g)}  - \ln(D_g^\sigma)-ln(\sum^G_{g=0}D^{(1-\sigma_g)}_g)
\end{align*}

\begin{align*}
\ln(s_0) &= \ln(\frac{1}{\sum^G_{g=0}D^{(1-\sigma)}_g}) \\
\ln(s_0) &= -\ln(\sum^G_{g=0}D^{(1-\sigma)}_g) 
\end{align*}

\begin{align*}
\ln(s_{j}) - \ln(s_0) &= \frac{\delta_{j}}{(1-\sigma)}  - \ln(D_g^\sigma)-ln(\sum^G_{g=0}D^{(1-\sigma)}_g) +\ln(\sum^G_{g=0}D^{(1-\sigma)}_g) \\
\ln(\frac{s_{j}}{s_0}) &= \frac{\delta_{j}}{(1-\sigma)}  - \sigma \ln(D_g) \\
\end{align*}

The market share of a certain segment g $s_g =\frac{D_g^{(1-\sigma_g)}}{\sum^G_{g=0}D^{(1-\sigma_g)}_g}$

\begin{align*}
\ln(s_g) &= \ln(\frac{D_g^{(1-\sigma_g)}}{\sum^G_{g=0}D^{(1-\sigma_g)}_g})\\
\ln(s_g) &= (1-\sigma) \ln(D_g) - \ln(s_0)\\
\ln(D_g) &= \frac{\ln(s_g) - \ln(s_0)}{1-\sigma}
\end{align*}

Defining $s_{j|g} = \frac{s_j}{s_k}$ and subsituting expression for $\ln(D_g)$ into $\ln(\frac{s_{j}}{s_0})$

\begin{align*}
\ln(\frac{s_{j}}{s_0}) &= \frac{\delta_{j}}{(1-\sigma)}  - \sigma \ln(D_g) \\
\ln(\frac{s_{j}}{s_0}) &= \frac{\delta_{j}}{(1-\sigma)}  - \sigma \frac{\ln(s_g) - \ln(s_0)}{1-\sigma} \\
(\ln(s_j) - \ln(s_0))(1-\sigma) &= \delta_{j} -\sigma (\ln(s_g) - \ln(s_0))\\
\ln(s_j) - \ln(s_0) -\ln(s_j)\sigma  & + \ln(s_0) \sigma + \sigma \ln(s_g)  + \sigma \ln(s_0) = \delta_{j}
\ln(\frac{s_{j}}{s_0}) -\sigma \ln(s_{j|g}) &= \delta_{j} \\
\ln(\frac{s_{j}}{s_0}) &= \delta_{j} +\sigma \ln(s_{j|g}) \\
\ln(\frac{s_{j}}{s_0}) &= \delta_{j} +\sigma \ln(s_{j|g}) \\ 
 \ln(\frac{s_{j}}{s_0})  &= x_{jt}\beta - \alpha p_{jt} + \gamma m_j + \xi_{jt}  +\sigma \ln(s_{j|g})
\end{align*}

This is the specification for a Berry-one-level nested logit which we will estimate using OLS and 2SLS. 



 
2. We continue to have an endogeinty problem with prices being correlated with our unobserved characteristics. In addition, now that were are clustering the products into groups according to segments, we will have endogeinty 

Optimal pricing of firms will imply a correlation between prices and unobserved product characteristics as in the regular logit but we will require two instruments since changes in unobserved characteristics will also effect the relative marketshare within a segment $\ln(s_{j|g})$. Once again we relly on within firm  characteristics, the sum of within segment product characteristics and all other firm product characteristics.  

3.

\begin{align*}
s_{j} &= \frac{\exp(\delta_{j}/(1-\sigma_g))\exp(I_g)}{\exp(I_g/(1-\sigma_g))\exp(I)} \\
I&=\ln(\sum^G_{g=0}\exp(I_g))\\  
I_g&=(1-\sigma_g)\ln(\sum^{J_g}_{j=1}\exp(\delta_j/(1-\sigma_g)))\\
\end{align*}

Using notation from Barry's paper, we can simplify summations by:

\begin{align*}
D_g &= \sum^{J_g}_{j=1}\exp(\delta_j/(1-\sigma_g)))\\
I_g&=(1-\sigma_g)\ln(D_g)\\
I&=\ln(\sum^G_{g=0}D^{(1-\sigma_g)}_g)\\  
\end{align*}

As a result, we can simplify our product shares formula:

\begin{align*}
s_{j} &= \frac{\exp(\delta_{j}/(1-\sigma_g))\exp((1-\sigma_g)\ln(D_g))}{(D_g)(\sum^G_{g=0}D^{(1-\sigma_g)}_g)} \\
s_{j} &= \frac{\exp(\delta_{j}/(1-\sigma_g))}{D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g} \\
\end{align*}

We can also lay out the equation for shares of outside good:

\begin{align*}
s_{0} &= \frac{1}{\sum^G_{g=0}D^{(1-\sigma_g)}_g} \\
\end{align*}

We determine our price elasticities, we need to know the probability of choosing one of the group g products:

\begin{align*}
s_g&=\frac{D_g^{(1-\sigma_g)}}{\sum^G_{g=0}D^{(1-\sigma_g)}_g}\\
s_{j|g} &= \frac{s_j}{s_g}=\frac{\exp(\delta_j/(1-\sigma_g))}{D_g} \\
\end{align*}

To find the own price elasticities, we will take the derivative of our product shares w.r.t. the products price. We can use the quotient rule to calculate the derivative:

\begin{align*}
\frac{\partial s_{j}}{\partial p_{j}} &= \bigg(\exp(\frac{\delta_j}{(1-\sigma_g)})(\frac{-\alpha}{(1-\sigma_g)})(D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g) - \dots\\ \dots &-\exp(\frac{\delta_j}{(1-\sigma_g)})\bigg(D_g^\sigma\sum^G_{g=0}((1-\sigma_g)D_g^{-\sigma}\exp(\frac{\delta_j}{(1-\sigma_g)})(\frac{-\alpha}{(1-\sigma_g)}))+\sigma D_g^{\sigma-1}\exp(\frac{\delta_j}{(1-\sigma_g)})(\frac{-\alpha}{(1-\sigma_g)})\sum^G_{g=0}D^{(1-\sigma_g)}_g\bigg)\bigg)\\
&\div (D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g)^2\\
&=-\alpha\exp(\frac{\delta_j}{(1-\sigma_g)})\frac{1}{(1-\sigma_g)}\bigg((D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g) -(1-\sigma_g)D_g^\sigma\sum^G_{g=0}D_g^{-\sigma}(\exp(\frac{\delta_j}{(1-\sigma_g)})) - \sigma D_g^{\sigma-1}\exp(\frac{\delta_j}{(1-\sigma_g)})\sum^G_{g=0}D^{(1-\sigma_g)}_g\bigg)\\
&\div (D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g)\\

&=-\frac{\alpha s_j}{(1-\sigma_g)}\bigg(1 -(1-\sigma_g)s_j -  \frac{\sigma D_g^{\sigma}s_{j|g}\sum^G_{g=0}D^{(1-\sigma_g)}_g}{(D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g)}\bigg) )\\

&=-\frac{\alpha s_j}{(1-\sigma_g)}(1 -(1-\sigma_g)s_j -  \sigma s_{j|g})\\
\end{align*}

From this we can calculate our own price elasticities:

\begin{align*}
\frac{\partial q_j}{\partial p_j} \frac{p_j}{q_j}&= L\frac{\partial s_j}{\partial p_j} \frac{p_j}{q_j}\\
&= L(-\frac{\alpha s_j}{(1-\sigma_g)}(1 -(1-\sigma_g)s_j -  \sigma s_{j|g}) ) \frac{p_j}{q_j}\\

&= L(-\frac{\alpha}{(1-\sigma_g)}\frac{q_j}{L}(1 -(1-\sigma_g)s_j -  \sigma s_{j|g}) ) \frac{p_j}{q_j}\\

&=-\frac{\alpha}{(1-\sigma_g)}(1 -(1-\sigma_g)s_j -  \sigma s_{j|g}))p_j\\

\end{align*}

If product k falls within the same segment as j, then we can calculate $\frac{\partial s_k}{\partial p_j}$ as:

\begin{align*}
\frac{\partial s_{k}}{\partial p_{j}} &= - \exp(\frac{\delta_k}{(1-\sigma_g)})(D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g)^{-2}\dots\\
&\dots\bigg(D_g^\sigma\sum^G_{g=0}((1-\sigma_g)D_g^{-\sigma}\exp(\frac{\delta_k}{(1-\sigma_g)})(\frac{-\alpha}{(1-\sigma_g)}))+\sigma D_g^{\sigma-1}\exp(\frac{\delta_k}{(1-\sigma_g)})(\frac{-\alpha}{(1-\sigma_g)})\sum^G_{g=0}D^{(1-\sigma_g)}_g\bigg)\bigg)\\
&=\frac{\alpha}{1-\sigma_g} s_k(D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g)^{-1}\bigg((1-\sigma_g)D_g^\sigma\sum^G_{g=0}(D_g^{-\sigma}\exp(\frac{\delta_k}{(1-\sigma_g)})+\sigma D_g^{\sigma-1}\exp(\frac{\delta_k}{(1-\sigma_g)})\sum^G_{g=0}D^{(1-\sigma_g)}_g\bigg)\bigg)\\
\frac{\partial s_{k}}{\partial p_{j}}&=\frac{\alpha}{1-\sigma_g} s_k((1-\sigma_g)s_k+\sigma s_{k|g})\\
\end{align*}

rom this we can calculate our cross price elasticities for products that are in the same segement:

\begin{align*}
\frac{\partial q_k}{\partial p_j} \frac{p_j}{q_k}&= L\frac{\partial s_k}{\partial p_j} \frac{p_j}{q_k}\\
&= L(\frac{\alpha}{1-\sigma_g} s_k((1-\sigma_g)s_k+\sigma_g s_{k|g}) ) \frac{p_j}{q_k}\\
&= (\frac{\alpha}{1-\sigma_g}((1-\sigma_g)s_k+\sigma_g s_{k|g}))p_j\\
\end{align*}

If product k falls outside the segment is in j, then we can calculate $\frac{\partial s_k}{\partial p_j}$ as:

\begin{align*}
\frac{\partial s_{k}}{\partial p_{j}} &= 
- \exp(\frac{\delta_k}{(1-\sigma_g)})(D_g^\sigma\sum^G_{g=0}D^{(1-\sigma_g)}_g)^{-2}\bigg(D_g^\sigma\sum^G_{g=0}((1-\sigma_g)D_g^{-\sigma}\exp(\frac{\delta_k}{(1-\sigma_g)})(\frac{-\alpha}{(1-\sigma_g)}))\bigg)\\
&= \alpha s_k s_j\\

\end{align*}

From this we can calculate our cross price elasticities for products that are outside of segments:

\begin{align*}
\frac{\partial q_k}{\partial p_j} \frac{p_j}{q_k}&= L\frac{\partial s_k}{\partial p_j} \frac{p_j}{q_k}\\
&= L(\alpha s_k s_j) \frac{p_j}{q_k}\\
&= \alpha s_j p_j\\
\end{align*}

4.

```{}
* PART 2. ONE LEVEL NESTED LOGIT INSTRUMENTS;
.                 foreach inst in `characteristics'{;
  2.         qui{;
  3.                 egen is_`inst'=sum(`inst'),  by (year country segment);
  4.                 egen ifs_`inst'=sum(`inst'), by (year country segment firm);
  5.                 gen CFis_`inst'=is_`inst'-ifs_`inst';
  6.                 replace is_`inst'=is_`inst'-`inst';
  7.                 replace ifs_`inst'=ifs_`inst'-`inst';
  8.         };
  9. };

. egen seg_sales=sum(qu), by(year country segment);

. egen is_num=count(qu), by(year country segment);

. egen fs_sales=sum(qu), by(year country segment firm);

. egen ifs_num=count (qu), by(year country segment firm);

. qui gen CFis_num=is_num-ifs_num;

. replace is_num=is_num-1;
(11483 real changes made)

. gen lnis_num=ln(is_num);
(3 missing values generated)

. replace ifs_num=ifs_num-1;
(11483 real changes made)

. gen lnifs_num=ln(ifs_num);
(4662 missing values generated)

. gen sigma=ln(qu/seg_sales);

* PART 2. ONE LEVEL NESTED LOGIT INSTRUMENTS;
.                 foreach inst in `characteristics'{;
  2.         qui{;
  3.                 egen is_`inst'=sum(`inst'),  by (year country segment);
  4.                 egen ifs_`inst'=sum(`inst'), by (year country segment firm);
  5.                 gen CFis_`inst'=is_`inst'-ifs_`inst';
  6.                 replace is_`inst'=is_`inst'-`inst';
  7.                 replace ifs_`inst'=ifs_`inst'-`inst';
  8.         };
  9. };

. egen seg_sales=sum(qu), by(year country segment);

. egen is_num=count(qu), by(year country segment);

. egen fs_sales=sum(qu), by(year country segment firm);

. egen ifs_num=count (qu), by(year country segment firm);

. qui gen CFis_num=is_num-ifs_num;

. replace is_num=is_num-1;
(11483 real changes made)

. gen lnis_num=ln(is_num);
(3 missing values generated)

. replace ifs_num=ifs_num-1;
(11483 real changes made)

. gen lnifs_num=ln(ifs_num);
(4662 missing values generated)

. gen sigma=ln(qu/seg_sales);
```

```{}
. xtreg rewr price sigma horsepower fuel width height domestic year country2-country5, fe;

Fixed-effects (within) regression               Number of obs      =     11483
Group variable: co                              Number of groups   =       351

R-sq:  within  = 0.8796                         Obs per group: min =         1
       between = 0.7876                                        avg =      32.7
       overall = 0.8453                                        max =       146

                                                F(12,11120)        =   6767.52
corr(u_i, Xb)  = 0.0199                         Prob > F           =    0.0000

------------------------------------------------------------------------------
        rewr |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.0491036   .0013895   -35.34   0.000    -.0518273   -.0463799
       sigma |   .8677908    .004327   200.55   0.000     .8593091    .8762725
  horsepower |   .0031765   .0006332     5.02   0.000     .0019354    .0044176
        fuel |  -.0255906   .0048552    -5.27   0.000    -.0351077   -.0160735
       width |   .0112444   .0017935     6.27   0.000     .0077288      .01476
      height |   .0012653   .0023704     0.53   0.593    -.0033811    .0059118
    domestic |   .3883771   .0127901    30.37   0.000     .3633063    .4134479
        year |  -.0025221    .001281    -1.97   0.049    -.0050331   -.0000111
    country2 |  -.3304413   .0120622   -27.39   0.000    -.3540853   -.3067972
    country3 |  -.2093509   .0120898   -17.32   0.000    -.2330489   -.1856528
    country4 |  -.4288399   .0126037   -34.02   0.000    -.4535454   -.4041344
    country5 |   -.104273   .0158302    -6.59   0.000     -.135303    -.073243
       _cons |  -.0712408   2.393163    -0.03   0.976    -4.762264    4.619783
-------------+----------------------------------------------------------------
     sigma_u |  .48769407
     sigma_e |  .38909072
         rho |   .6110556   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F test that all u_i=0:     F(350, 11120) =    19.01          Prob > F = 0.0000

. xtivreg rewr (price sigma= i_horsepower i_fuel i_width i_height i_domestic
>                                                         if_horsepower if_fuel if_width if_height if_domesti
> c
>                                                         is_horsepower is_fuel is_width is_height is_domesti
> c
>                                                         ifs_horsepower ifs_fuel ifs_width ifs_height ifs_do
> mestic)
>                                                         horsepower fuel width height domestic year country2
> -country5, fe;

Fixed-effects (within) IV regression         Number of obs      =        11483
Group variable: co                           Number of groups   =          351

R-sq:  within  = 0.6001                      Obs per group: min =            1
       between = 0.3725                                     avg =         32.7
       overall = 0.5520                                     max =          146

                                             Wald chi2(12)      =     1.21e+06
corr(u_i, Xb)  = 0.0068                      Prob > chi2        =       0.0000

------------------------------------------------------------------------------
        rewr |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.1232378   .0109746   -11.23   0.000    -.1447476    -.101728
       sigma |   .2110286   .0293953     7.18   0.000     .1534147    .2686424
  horsepower |   .0044865    .002236     2.01   0.045     .0001041    .0088689
        fuel |  -.0541376   .0089089    -6.08   0.000    -.0715987   -.0366766
       width |   .0551482   .0036227    15.22   0.000     .0480478    .0622486
      height |   .0255373   .0044086     5.79   0.000     .0168965    .0341781
    domestic |   1.469756   .0545059    26.97   0.000     1.362926    1.576585
        year |  -.0491546   .0031366   -15.67   0.000    -.0553022   -.0430071
    country2 |  -.7585582   .0326599   -23.23   0.000    -.8225704   -.6945461
    country3 |  -.7591188   .0294356   -25.79   0.000    -.8168116    -.701426
    country4 |  -.5304193   .0382404   -13.87   0.000    -.6053692   -.4554694
    country5 |    .142352   .0919044     1.55   0.121    -.0377774    .3224814
       _cons |   80.93904   5.890503    13.74   0.000     69.39387    92.48422
-------------+----------------------------------------------------------------
     sigma_u |  .88552239
     sigma_e |  .70896758
         rho |  .60938692   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F  test that all u_i=0:     F(350,11120) =     7.38       Prob > F    = 0.0000
------------------------------------------------------------------------------
Instrumented:   price sigma
Instruments:    horsepower fuel width height domestic year country2 country3
                country4 country5 i_horsepower i_fuel i_width i_height
                i_domestic if_horsepower if_fuel if_width if_height
                if_domestic is_horsepower is_fuel is_width is_height
                is_domestic ifs_horsepower ifs_fuel ifs_width ifs_height
                ifs_domestic
------------------------------------------------------------------------------
```

The coefficent on prices is now -.1232378 and we have estimated $\sigma_g$ = .2110286. We can input these values with the known values for shares to find our own- and cross-price elasticities.

# 4.1 Logit Estimation 

Model:

\begin{align*}
u_{ijt} = \beta_0 + \beta^f f_{jt} + \beta^d d_{jt} + \alpha p_{jt} + \xi_{jt} + \epsilon_{ijt}
\end{align*}

constant: vector of ones,
f: amount of caffeine 
d: degrees of roasting
Zopt : Instrument Matrix 
shares: Market Share 

Estimating model using ols in MATLAB, must have data.mat in memory. I don't include constant in 1 since Lfit already includes constant.  

```{}
lnshares = log(shares)
X = [constant,p,f,d]
mdl = fitlm(X,lnshares)
mdl.Coefficients

ans = 
                   Estimate       SE        tStat       pValue   
                   ________    ________    _______    ___________

    (Intercept)          0            0        NaN            NaN
    x1             0.39685      0.50184    0.79079        0.42983
    x2             -1.7528     0.032324    -54.225    1.8198e-138
    x3              2.9999       0.2169     13.831     1.5287e-32
    x4             0.82219      0.22297     3.6875     0.00027893
```
Using Matrix notation found in Cameron Trivendi because I couldn't find 2SLS function. 

```{}
X = [constant,p,f,d]
Z = instrument

B2SLS = inv(X.'*Z*inv(Z.'*Z)*Z.'*X)*X.'*Z*inv(Z.'*Z)*Z.'*lnshares

ans = 

B2SLS =

    1.7079
   -1.9519
    3.1361
    0.9306

 u = minus(lnshares,X*B2SLS)
 s2 = ((250-4)^-1)*u.'*u
 VB2ls = s2*inv(X.'*Z*inv(Z.'*Z)*Z.'*X)

VB2ls =

    0.3126   -0.0114   -0.0682   -0.0736
   -0.0114    0.0017   -0.0012   -0.0009
   -0.0682   -0.0012    0.0543   -0.0024
   -0.0736   -0.0009   -0.0024    0.0573

SE = diag(sqrt(VB2ls))

SE =

    0.5591
    0.0416
    0.2331
    0.2394
```

There must be a better way to do Varinace. Here i get the projection matrix , generate residuals, calculate variance under homoskedasticity 

Compare standard errors and coefficients. This model is correct cause of part 2. 

# 4.2 Random Coefficients Logit (BLP)

1. 

2. 

<<<<<<< HEAD
```{}
	* PART 2. ONE LEVEL NESTED LOGIT INSTRUMENTS;
	
	
foreach inst in `characteristics'{;
	qui{;
		egen is_`inst'=sum(`inst'),  by (year country segment);
		egen ifs_`inst'=sum(`inst'), by (year country segment firm);
		gen CFis_`inst'=is_`inst'-ifs_`inst';
		replace is_`inst'=is_`inst'-`inst';
		replace ifs_`inst'=ifs_`inst'-`inst';
	};
};

egen seg_sales=sum(qu), by(year country segment);
egen is_num=count(qu), by(year country segment);

egen fs_sales=sum(qu), by(year country segment firm);
egen ifs_num=count (qu), by(year country segment firm);

qui gen CFis_num=is_num-ifs_num;

replace is_num=is_num-1;
gen lnis_num=ln(is_num);
replace ifs_num=ifs_num-1;
gen lnifs_num=ln(ifs_num);

gen rewr2=ln(qu/seg_sales);
xtreg rewr price rewr2 horsepower fuel width height domestic year country2-country5, fe;

xtivreg rewr (price rewr2= i_horsepower i_fuel i_width i_height i_domestic
							if_horsepower if_fuel if_width if_height if_domestic
							is_horsepower is_fuel is_width is_height is_domestic
							ifs_horsepower ifs_fuel ifs_width ifs_height ifs_domestic)
							horsepower fuel width height domestic year country2-country5, fe;
```

```{}
. xtreg rewr price rewr2 horsepower fuel width height domestic year country2-country5, fe;

Fixed-effects (within) regression               Number of obs      =     11483
Group variable: co                              Number of groups   =       351

R-sq:  within  = 0.8796                         Obs per group: min =         1
       between = 0.7876                                        avg =      32.7
       overall = 0.8453                                        max =       146

                                                F(12,11120)        =   6767.52
corr(u_i, Xb)  = 0.0199                         Prob > F           =    0.0000

------------------------------------------------------------------------------
        rewr |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.0491036   .0013895   -35.34   0.000    -.0518273   -.0463799
       rewr2 |   .8677908    .004327   200.55   0.000     .8593091    .8762725
  horsepower |   .0031765   .0006332     5.02   0.000     .0019354    .0044176
        fuel |  -.0255906   .0048552    -5.27   0.000    -.0351077   -.0160735
       width |   .0112444   .0017935     6.27   0.000     .0077288      .01476
      height |   .0012653   .0023704     0.53   0.593    -.0033811    .0059118
    domestic |   .3883771   .0127901    30.37   0.000     .3633063    .4134479
        year |  -.0025221    .001281    -1.97   0.049    -.0050331   -.0000111
    country2 |  -.3304413   .0120622   -27.39   0.000    -.3540853   -.3067972
    country3 |  -.2093509   .0120898   -17.32   0.000    -.2330489   -.1856528
    country4 |  -.4288399   .0126037   -34.02   0.000    -.4535454   -.4041344
    country5 |   -.104273   .0158302    -6.59   0.000     -.135303    -.073243
       _cons |  -.0712408   2.393163    -0.03   0.976    -4.762264    4.619783
-------------+----------------------------------------------------------------
     sigma_u |  .48769407
     sigma_e |  .38909072
         rho |   .6110556   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F test that all u_i=0:     F(350, 11120) =    19.01          Prob > F = 0.0000

. xtivreg rewr (price rewr2= i_horsepower i_fuel i_width i_height i_domestic
>                                                         if_horsepower if_fuel if_width if_height if_domesti
> c
>                                                         is_horsepower is_fuel is_width is_height is_domesti
> c
>                                                         ifs_horsepower ifs_fuel ifs_width ifs_height ifs_do
> mestic)
>                                                         horsepower fuel width height domestic year country2
> -country5, fe;

Fixed-effects (within) IV regression         Number of obs      =        11483
Group variable: co                           Number of groups   =          351

R-sq:  within  = 0.6001                      Obs per group: min =            1
       between = 0.3725                                     avg =         32.7
       overall = 0.5520                                     max =          146

                                             Wald chi2(12)      =     1.21e+06
corr(u_i, Xb)  = 0.0068                      Prob > chi2        =       0.0000

------------------------------------------------------------------------------
        rewr |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.1232378   .0109746   -11.23   0.000    -.1447476    -.101728
       rewr2 |   .2110286   .0293953     7.18   0.000     .1534147    .2686424
  horsepower |   .0044865    .002236     2.01   0.045     .0001041    .0088689
        fuel |  -.0541376   .0089089    -6.08   0.000    -.0715987   -.0366766
       width |   .0551482   .0036227    15.22   0.000     .0480478    .0622486
      height |   .0255373   .0044086     5.79   0.000     .0168965    .0341781
    domestic |   1.469756   .0545059    26.97   0.000     1.362926    1.576585
        year |  -.0491546   .0031366   -15.67   0.000    -.0553022   -.0430071
    country2 |  -.7585582   .0326599   -23.23   0.000    -.8225704   -.6945461
    country3 |  -.7591188   .0294356   -25.79   0.000    -.8168116    -.701426
    country4 |  -.5304193   .0382404   -13.87   0.000    -.6053692   -.4554694
    country5 |    .142352   .0919044     1.55   0.121    -.0377774    .3224814
       _cons |   80.93904   5.890503    13.74   0.000     69.39387    92.48422
-------------+----------------------------------------------------------------
     sigma_u |  .88552239
     sigma_e |  .70896758
         rho |  .60938692   (fraction of variance due to u_i)
------------------------------------------------------------------------------
F  test that all u_i=0:     F(350,11120) =     7.38       Prob > F    = 0.0000
------------------------------------------------------------------------------
Instrumented:   price rewr2
Instruments:    horsepower fuel width height domestic year country2 country3
                country4 country5 i_horsepower i_fuel i_width i_height
                i_domestic if_horsepower if_fuel if_width if_height
                if_domestic is_horsepower is_fuel is_width is_height
                is_domestic ifs_horsepower ifs_fuel ifs_width ifs_height
                ifs_domestic
------------------------------------------------------------------------------

. 

```
=======
>>>>>>> origin/master

Results with 10 draws 

```{}
Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6810]    [  0.6540]    [  4.0992]
    'price'         [-1.9808]    [  0.0466]    [-42.5372]
    'char1'         [ 1.9077]    [  0.4342]    [  4.3936]
    'char2'         [ 0.9549]    [  0.2648]    [  3.6067]
    'sigmachar1'    [ 1.3902]    [  0.2849]    [  4.8790]
```

Results with 50 draws 

```{}
Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6029]    [  0.5835]    [  4.4607]
    'price'         [-1.9815]    [  0.0408]    [-48.5259]
    'char1'         [ 2.3482]    [  0.3197]    [  7.3458]
    'char2'         [ 0.8895]    [  0.2338]    [  3.8048]
    'sigmachar1'    [ 0.9038]    [  0.1400]    [  6.4537]
```

Results with 100 draws

```{}

Result of Random Coefficient Logit
    'var'           'coef'       'std.err.'    'tvalue'  
    'constant'      [ 2.6263]    [  0.5650]    [  4.6486]
    'price'         [-1.9774]    [  0.0401]    [-49.3514]
    'char1'         [ 2.2058]    [  0.3225]    [  6.8401]
    'char2'         [ 0.9889]    [  0.2285]    [  4.3273]
    'sigmachar1'    [-0.9160]    [  0.1311]    [ -6.9849]
```
As we can 
